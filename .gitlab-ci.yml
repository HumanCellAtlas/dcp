image: python:3.6

stages:
  - dcp_wide_test
  - 1000_cell_test

before_script:
  - apt-get -y update
  - apt-get -y install jq
  - pip install -r requirements.txt
  - export SWAGGER_URL="https://dss.$CI_COMMIT_REF_NAME.data.humancellatlas.org/v1/swagger.json"
  - mkdir -p ~/.config/hca
  - jq -n .DSSClient.swagger_url=env.SWAGGER_URL > ~/.config/hca/config.$CI_COMMIT_REF_NAME.json
  - export HCA_CONFIG_FILE=~/.config/hca/config.$CI_COMMIT_REF_NAME.json

dcp_wide_test:
  stage: dcp_wide_test
  only:
    - integration
    - staging
  script:
    - make test

1000_cell_test:
  stage: 1000_cell_test
  only:
    - 1000_cell_test
  script:
    - CI_COMMIT_REF_NAME=integration python -m unittest tests.scale.test_big_bundles.TestBigBundles.test_one_submission_with_1000_bundles
